<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Visuomotor Adaptation - Trackpad/Tablet Demo</title>
  <style>
    canvas { 
        background: #eef; 
        display: block; 
        margin: 1em auto;
        cursor: none;        /* <---- THIS HIDES THE SYSTEM MOUSE/POINTER */
    }
    #plots { display: none; }
    #taskArea { text-align: center; }
    body { font-family: Arial, sans-serif; }
  </style>
</head>
<body>
<h2 style="text-align:center;">Visuomotor Adaptation Demo</h2>
<div id="taskArea">
  <canvas id="canvas" width="600" height="600"></canvas>
  <div id="info"></div>
</div>
<div id="plots">
  <h3 style="text-align:center;">Results</h3>
  <canvas id="plot1" width="600" height="300"></canvas>
  <canvas id="plot2" width="600" height="300"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const nTrials = 30;
const home = {x:300, y:500};
const target = {x:300, y:100};
const targetRadius = 12;
const homeRadius = 15;
const cursorRadius = 7;
const reachDistance = Math.abs(home.y - target.y);
const rotationDeg = 30;
const rotationRad = rotationDeg * Math.PI/180;
const gain = 2.0;      // Cursor amplitude gain

let trial = 0;
let isTrialActive = false;
let cursorPos = {...home};
let handStart = null;
let reachDirections = [];
let cursorAngles = [];
let angleErrors = [];

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let info = document.getElementById('info');

// Draw everything (no hand shown, only cursor)
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // home position
    ctx.beginPath();
    ctx.arc(home.x, home.y, homeRadius, 0, 2 * Math.PI);
    ctx.fillStyle = "#88F";
    ctx.fill();

    // target position
    ctx.beginPath();
    ctx.arc(target.x, target.y, targetRadius, 0, 2 * Math.PI);
    ctx.fillStyle = "#F88";
    ctx.fill();

    // cursor
    ctx.beginPath();
    ctx.arc(cursorPos.x, cursorPos.y, cursorRadius, 0, 2 * Math.PI);
    ctx.fillStyle = "#444";
    ctx.fill();
}

function setInfo(msg) {
    info.textContent = msg;
}

function startTrial() {
    cursorPos = {...home};
    handStart = null; // will be set on first move
    isTrialActive = true;
    draw();
    setInfo(`Trial ${trial+1}/${nTrials}: Move the cursor towards the target by moving your finger/mouse.`);
    window.addEventListener('pointermove', globalPointerMove);
}

function updateCursorFromHand(mx, my) {
    if (!isTrialActive) return;

    // set handStart if not set (first move in trial)
    if (!handStart) handStart = {x: mx, y: my};

    // displacement vector from home according to hand movement
    let dx = mx - handStart.x;
    let dy = my - handStart.y;

    // --------- GAIN APPLIED HERE ---------------
    let r = Math.sqrt(dx*dx + dy*dy) * gain;
    // -------------------------------------------

    let theta = Math.atan2(dy, dx);

    // Apply VISUAL rotation
    let thetaVis = theta + rotationRad;

    // Calculate cursor
    let cx = home.x + r * Math.cos(thetaVis);
    let cy = home.y + r * Math.sin(thetaVis);

    cursorPos.x = cx;
    cursorPos.y = cy;
    draw();

    // Check if rotated cursor reached far enough (distance from home)
    let cursorDist = Math.hypot(cx-home.x, cy-home.y);
    if (cursorDist >= reachDistance) {
        finishTrial(theta, thetaVis);
    }
}

// --- Fix: Global Pointer Event ---
function globalPointerMove(e) {
    const rect = canvas.getBoundingClientRect();
    let mx = e.clientX - rect.left;
    let my = e.clientY - rect.top;
    updateCursorFromHand(mx, my);
}

canvas.addEventListener('pointerdown', e => {
    if (!isTrialActive && trial < nTrials) {
        startTrial();
    }
    const rect = canvas.getBoundingClientRect();
    let mx = e.clientX - rect.left;
    let my = e.clientY - rect.top;
    if (!handStart && isTrialActive) handStart = {x: mx, y: my};
});

canvas.addEventListener('pointerup', e => {});

canvas.addEventListener('touchstart', e => { e.preventDefault(); });
canvas.addEventListener('touchmove', e => { e.preventDefault(); });

// Finish
function finishTrial(handTheta, cursorTheta) {
    isTrialActive = false;
    window.removeEventListener('pointermove', globalPointerMove);

    let handAngleDeg = handTheta * 180 / Math.PI;
    let cursorAngleDeg = cursorTheta * 180 / Math.PI;

    let targetDx = target.x - home.x;
    let targetDy = target.y - home.y;
    let targetAngleRad = Math.atan2(targetDy, targetDx);
    let targetAngleDeg = targetAngleRad * 180 / Math.PI;
    let errorAngle = cursorAngleDeg - targetAngleDeg;

    reachDirections.push(handAngleDeg);
    cursorAngles.push(cursorAngleDeg);
    angleErrors.push(errorAngle);

    trial++;

    // Reset cursor to home for next trial
    cursorPos = { ...home };
    draw();

    if (trial >= nTrials) {
        setInfo("Trials finished!");
        setTimeout(endTask, 500);
    } else {
        setInfo(`Trial ${trial}/${nTrials} completed. The cursor is reset at home. Pointer to the blue circle and move again for the next trial.`);
    }
}

// Start
draw();
setInfo(`Pointer to the blue circle ("home") and move finger/mouse to start Trial 1.`);

canvas.addEventListener('pointerdown', function(e) {
    if (!isTrialActive && trial < nTrials) {
        const rect = canvas.getBoundingClientRect();
        let mx = e.clientX - rect.left;
        let my = e.clientY - rect.top;
        let dist = Math.hypot(mx-home.x, my-home.y);
        if (dist < homeRadius+10)
            startTrial();
    }
});

// Show results
function endTask() {
    document.getElementById('taskArea').style.display = "none";
    document.getElementById('plots').style.display = "block";
    new Chart(document.getElementById('plot1'),{
        type:'line',
        data:{
            labels: [...Array(nTrials).keys()].map(x=>x+1),
            datasets:[
                {
                    label: "Hand reach direction (deg)",
                    data: reachDirections,
                    borderColor: "#88F",
                    pointStyle:'cross',
                    fill:false
                },
                {
                    label: "Cursor direction (deg)",
                    data: cursorAngles,
                    borderColor: "#444",
                    borderDash: [5,5],
                    fill:false
                },
                {
                    label:"Target direction (deg)",
                    data: Array(nTrials).fill(
                        Math.atan2(target.y-home.y,target.x-home.x)*180/Math.PI),
                    borderColor:"#F88",
                    borderDash:[2,2],
                    fill:false
                }
            ]
        },
        options:{responsive:false,
            plugins:{title:{display:true,text:"Reach direction per trial"}},
            scales:{y:{beginAtZero:false, title:{text:"Angle (deg)",display:true}}, x:{title:{text:"Trial#",display:true}}}
        }
    });
    new Chart(document.getElementById('plot2'),{
        type:'line',
        data:{
            labels: [...Array(nTrials).keys()].map(x=>x+1),
            datasets:[{
                label:"Cursor-Target Angle Error (deg)",
                data: angleErrors,
                borderColor: "#F88",
                fill:false
            }]
        },
        options:{responsive:false,
            plugins:{title:{display:true,text:"Cursor angle error vs trial"}},
            scales:{y:{beginAtZero:false, title:{text:"Angular error (deg)",display:true}}, x:{title:{text:"Trial#",display:true}}}
        }
    });
}
</script>
</body>
</html>
